name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - 'projects/**'
      - 'tools/**'
      - 'packages/**'
      - 'tests/**'
      - 'scripts/**'
      - 'eslint.config.js'
      - 'package.json'
      - 'package-lock.json'
      - 'pyproject.toml'
      - '.github/workflows/**'
      - 'docs/examples/**'
      - '!docs/**/*.md'
      - '!docs/**/*.yml'
  pull_request:
    branches: [main]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - 'projects/**'
      - 'tools/**'
      - 'packages/**'
      - 'tests/**'
      - 'scripts/**'
      - 'eslint.config.js'
      - 'package.json'
      - 'package-lock.json'
      - 'pyproject.toml'
      - '.github/workflows/**'
      - 'docs/examples/**'
      - '!docs/**/*.md'
      - '!docs/**/*.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24.6.0
      - run: npm ci
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r projects/04-llm-adapter-shadow/requirements.txt
      - name: Run Node test suites
        run: |
          set -euxo pipefail
          npm run spec:validate
          npm run e2e:gen
          bash scripts/run-node-suite.sh
          npm run ci:analyze
          npm run ci:issue
          node --test tests/e2e-shadow.test.mjs
      - name: Run Python tests (verbose, timeout, no network)
        env:
          LLM_ADAPTER_OFFLINE: "1"
          OLLAMA_AUTO_PULL: "0"
          OLLAMA_TIMEOUT_S: "5"
          OLLAMA_PULL_TIMEOUT_S: "20"
          OLLAMA_BASE_URL: "http://127.0.0.1:9"
        run: |
          set -euxo pipefail
          python -c "import pytest, sys; sys.exit(pytest.main(['-vv', '-s', '--maxfail=1', '--durations=20', '--disable-socket', 'projects/04-llm-adapter-shadow/tests']))"
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: |
            junit-results.xml
            projects/03-ci-flaky/out
          if-no-files-found: warn
